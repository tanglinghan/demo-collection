<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >

<mapper namespace="top.b0x0.demo.distributedLock.db.DistributedLockMapper">

    <!-- 使用排它锁（for update） -->
    <select id="getLockByResourceName" resultType="top.b0x0.demo.distributedLock.domain.DistributedLock">
        SELECT *
        FROM t_sys_distributedlock
        where resource_name = #{resourceName} for update;
    </select>
    <update id="locked" parameterType="top.b0x0.demo.distributedLock.domain.DistributedLock">
        update t_sys_distributedlock
        set lock_status = 'LOCK',
        expiration_time = #{expirationTime},
        <!-- version     = version + 1 -->
        where reource_name = #{resourceName}
        <!-- and version = 0;  -->
    </update>
    <update id="releaseLock" parameterType="top.b0x0.demo.distributedLock.domain.DistributedLock">
        update t_sys_distributedlock
        set lock_status = 'UNLOCK',
        <!--  version     = version - 1  -->
        where reource_name = #{resourceName}
        <!-- and version = 1; -->
    </update>

</mapper>
